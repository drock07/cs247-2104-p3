var p3App=angular.module("p3App",["ui.router","firebase"]);p3App.config(["$stateProvider","$locationProvider","$urlRouterProvider",function(e,o,r){o.html5Mode(!0),r.otherwise("/signin"),e.state("home",{url:"/",templateUrl:"/partials/home.html",controller:"HomeCtrl"}).state("chatroom",{url:"/chatroom/:chatroomId",templateUrl:"/partials/chatroom.html",controller:"ChatroomCtrl"}).state("signin",{url:"/signin",onEnter:function(){}})}]),p3App.run(["$rootScope","Chatrooms",function(e,o){e.userModel={},e.$on("$stateChangeStart",function(r,t,n,a,s){"chatroom"==a.name&&o.signout(s.chatroomId,e.userModel.username)})}]),p3App.factory("Chatrooms",["$firebase",function(e){var o=e(new Firebase("https://glaring-fire-5264.firebaseio.com/")),r=o.$child("chatrooms"),t={list:function(){return r},get:function(e){return r.$child(e)},send:function(e,o,t){r.$child(e+"/stream").$add({m:o,username:t})},signin:function(e,o){var t=r.$child(e+"/users");t[o]=!0,t.$save(o);var n=new Firebase("https://glaring-fire-5264.firebaseio.com/chatrooms/"+e+"/users/"+o);n.onDisconnect().remove()},signout:function(e,o){r.$child(e+"/users").$remove(o);var t=new Firebase("https://glaring-fire-5264.firebaseio.com/chatrooms/"+e+"/users/"+o);t.onDisconnect().cancel()}};return t}]),p3App.directive("ngEnter",function(){return function(e,o,r){o.bind("keydown keypress",function(o){13===o.which&&(e.$apply(function(){e.$eval(r.ngEnter)}),o.preventDefault())})}}),p3App.directive("chatVideo",function(){return{restrict:"AE",link:function(e,o){var r={video:!0,audio:!1},t=function(e){var r=o,t=document.createElement("video");r.innerHTML="",t=mergeProps(t,{controls:!1,src:URL.createObjectURL(e)}),t.play(),r.append(t),console.log("connect to media stream!")},n=function(e){console.error("media error",e)};navigator.getUserMedia(r,t,n)}}}),p3App.controller("AppCtrl",["$scope","$state",function(){}]),p3App.controller("HomeCtrl",["$scope","Chatrooms",function(e,o){e.chatrooms=o.list()}]),p3App.controller("ChatroomCtrl",["$scope","$stateParams","Chatrooms","$window","$rootScope",function(e,o,r,t,n){for(e.chatroomId=o.chatroomId,e.chatroom=r.get(o.chatroomId);!n.userModel.username;)n.userModel.username="david";r.signin(e.chatroomId,n.userModel.username),e.sendChatMessage=function(){e.chatMessage&&""!=e.chatMessage&&(r.send(e.chatroomId,e.chatMessage,n.userModel.username),e.chatMessage="")}}]);