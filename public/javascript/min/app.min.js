var p3App=angular.module("p3App",["ui.router","firebase"]);p3App.config(["$stateProvider","$locationProvider","$urlRouterProvider",function(e,o,r){o.html5Mode(!0),r.otherwise("/signin"),e.state("home",{url:"/",views:{content:{templateUrl:"/partials/home.html",controller:"HomeCtrl"}}}).state("chatroom",{url:"/chatroom/:chatroomId",views:{content:{templateUrl:"/partials/chatroom.html",controller:"ChatroomCtrl"},"user-list":{templateUrl:"/partials/userList.html",controller:"ChatroomUsersCtrl"}}}).state("signin",{url:"/signin",onEnter:function(e,o,r,t){r.userModel.username=t.prompt("Please choose a username."),r.userModel.username||(r.userModel.username="anonymous"+Math.floor(1111*Math.random())),o.go("home")}})}]),p3App.run(["$rootScope","Chatrooms","$state","$window",function(e,o,r,t){e.userModel={},e.$on("$stateChangeStart",function(r,n,a,s,c){e.userModel.username?"chatroom"==s.name&&o.signout(c.chatroomId,e.userModel.username):(e.userModel.username=t.prompt("Please choose a username."),e.userModel.username||(e.userModel.username="anonymous"+Math.floor(1111*Math.random())))})}]),p3App.factory("Chatrooms",["$firebase",function(e){var o=e(new Firebase("https://glaring-fire-5264.firebaseio.com/")),r=o.$child("chatrooms"),t={list:function(){return r},newRoom:function(){return r.$add({})},get:function(e){return r.$child(e)},getUsers:function(e){return r.$child(e+"/users")},getEmoticons:function(e){return r.$child(e+"/emoticons")},send:function(e,o,t){r.$child(e+"/stream").$add({m:o,username:t})},sendEmoticon:function(e,o,t){r.$child(e+"/stream").$add({username:o,v:t})},signin:function(e,o){var t=r.$child(e+"/users");t[o]=!0,t.$save(o);var n=new Firebase("https://glaring-fire-5264.firebaseio.com/chatrooms/"+e+"/users/"+o);n.onDisconnect().remove()},signout:function(e,o){r.$child(e+"/users").$remove(o);var t=new Firebase("https://glaring-fire-5264.firebaseio.com/chatrooms/"+e+"/users/"+o);t.onDisconnect().cancel()}};return t}]),p3App.factory("Base64Converter",[function(){return{blobToBase64:function(e,o){var r=new FileReader;r.onload=function(){var e=r.result,t=e.split(",")[1];o(t)},r.readAsDataURL(e)},base64ToBlob:function(e){for(var o=atob(e),r=o.length,t=new ArrayBuffer(r),n=new Uint8Array(t),a=0;r>a;a++)n[a]=o.charCodeAt(a);var s=new Blob([n]);return s}}}]),p3App.directive("ngEnter",function(){return function(e,o,r){o.bind("keydown keypress",function(o){13===o.which&&(e.$apply(function(){e.$eval(r.ngEnter)}),o.preventDefault())})}}),p3App.directive("chatVideo",["$timeout","$rootScope","Base64Converter","Chatrooms",function(e,o,r,t){return{restrict:"AE",link:function(n,a){n.mediaRecorder=null;var s={video:!0,audio:!1};n.recordVideo=function(){e(function(){r.blobToBase64(n.curVideoBlob,function(e){t.sendEmoticon(o.chatroomId,o.userModel.username,e)})},1500)};var c=function(e){var o=document.createElement("video");o=mergeProps(o,{controls:!1,src:URL.createObjectURL(e)}),o.play(),a.prepend(o),n.mediaRecorder=new MediaStreamRecorder(e),n.mediaRecorder.mimeType="video/webm",n.mediaRecorder.video_width=80,n.mediaRecorder.video_height=60,n.mediaRecorder.ondataavailable=function(e){n.curVideoBlob=e},setInterval(function(){n.mediaRecorder.stop(),n.mediaRecorder.start(1500)},1500),console.log("connect to media stream!")},i=function(e){console.error("media error",e)};navigator.getUserMedia(s,c,i)}}}]),p3App.controller("AppCtrl",["$scope","$state",function(e){e.$on("$stateChangeSuccess",function(o,r){e.currentState=r.name})}]),p3App.controller("HomeCtrl",["$scope","$state","Chatrooms",function(e,o,r){e.chatrooms=r.list(),e.makeNewChat=function(){var e=r.newRoom();o.go("chatroom",{chatroomId:e.name()})}}]),p3App.controller("ChatroomCtrl",["$scope","$rootScope","$stateParams","Chatrooms","$window","Base64Converter",function(e,o,r,t,n,a){o.chatroomId=r.chatroomId,e.chatroom=t.get(r.chatroomId),e.users=t.getUsers(r.chatroomId),t.signin(o.chatroomId,o.userModel.username),e.sendChatMessage=function(){e.chatMessage&&""!=e.chatMessage&&(t.send(o.chatroomId,e.chatMessage,o.userModel.username),e.chatMessage="")};var s=new Firebase("https://glaring-fire-5264.firebaseio.com/chatrooms/"+o.chatroomId+"/stream");s.on("child_added",function(e){var o=e.val();if(o.m)$("#chatStream").append("<p>"+o.username+": "+o.m+"</p>");else if(o.v){var r=document.createElement("video");r.autoplay=!0,r.controls=!1,r.loop=!0,r.width=120;var t=document.createElement("source");t.src=URL.createObjectURL(a.base64ToBlob(o.v)),t.type="video/webm",r.appendChild(t),$("#chatStream").append("<p>"+o.username+":</p>"),document.getElementById("chatStream").appendChild(r)}})}]),p3App.controller("ChatroomUsersCtrl",["$scope","$stateParams","Chatrooms",function(e,o,r){e.users=r.getUsers(o.chatroomId)}]);